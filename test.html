<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Butterfly Chart by Country</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .chart-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .bar {
            fill: steelblue;
        }
        .bar:hover {
            fill: orange;
        }
        .axis text {
            font-size: 12px;
        }
        .axis .domain {
            display: none;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 5px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        h2 {
            text-align: center;
        }
        .region-select {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h2>Butterfly Chart: Total Affected and Total CPI by Country</h2>
        <div class="region-select">
            <label for="regionSelect">Select Region:</label>
            <select id="regionSelect"></select>
        </div>
        <svg id="chart"></svg>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        d3.csv("cleaned_data.csv").then(function(data) {
            data.forEach(function(d) {
                d["Total Affected"] = +d["Total Affected"];
                d["CPI"] = +d["CPI"]; // Parse CPI as a number
            });

            const aggregatedData = d3.rollups(
                data,
                v => ({
                    total_affected: d3.sum(v, d => d["Total Affected"]),
                    total_cpi: d3.sum(v, d => d["CPI"]), // Calculate total CPI per country
                }),
                d => [d.Region, d.Country] // Aggregate by both region and country
            ).map(([keys, values]) => ({
                region: keys[0],
                country: keys[1],
                total_affected: values.total_affected,
                total_cpi: values.total_cpi, // Total CPI per country
            }));

            // Sort aggregatedData by total_cpi in descending order
            aggregatedData.sort((a, b) => b.total_cpi - a.total_cpi);

            const margin = { top: 20, right: 30, bottom: 100, left: 100 }; // Increased bottom margin
            const width = 1200 - margin.left - margin.right;
            const height = 600 - margin.top - margin.bottom; // Increased total height
            const gap = 200; // Gap between the two sets of bars

            const svg = d3.select("#chart")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left - 60},${margin.top})`); // Shifted the chart to the left

            const xAffected = d3.scaleLinear()
                .domain([0, d3.max(aggregatedData, d => d.total_affected)]) // Adjusted to use the maximum total_affected value directly
                .range([(width - gap) / 2, 0]); // Reversed range to start from right

            const xCPI = d3.scaleLinear()
                .domain([0, d3.max(aggregatedData, d => d.total_cpi) * 1.2]) // Increased domain range for Total CPI
                .range([0, (width - gap) / 2]);

            const y = d3.scaleBand()
                .domain(aggregatedData.map(d => d.country)) // Use country names for y domain
                .range([0, height])
                .padding(0.1);

            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip");

            // Populate region select dropdown
            const regionSelect = d3.select("#regionSelect");
            regionSelect.selectAll("option")
                .data([...new Set(aggregatedData.map(d => d.region))]) // Get unique regions
                .enter().append("option")
                .attr("value", d => d)
                .text(d => d);

            // Function to update chart based on selected region
            function updateChart(selectedRegion) {
                const selectedData = aggregatedData.filter(d => d.region === selectedRegion);

                // Update y scale domain with countries of selected region
                y.domain(selectedData.map(d => d.country));

                // Update total affected bars
                svg.selectAll(".bar.total_affected")
                    .data(selectedData, d => d.country)
                    .join(
                        enter => enter.append("rect")
                            .attr("class", "bar total_affected")
                            .attr("x", d => (width - gap) / 2 - xAffected(d.total_affected))
                            .attr("y", d => y(d.country))
                            .attr("width", d => xAffected(d.total_affected))
                            .attr("height", y.bandwidth())
                            .attr("fill", "#1f77b4")
                            .on("mouseover", function(event, d) {
                                tooltip.style("opacity", 1)
                                    .html(`<strong>Total Affected</strong><br>${d.total_affected}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 15) + "px");
                                d3.select(this).attr("fill", "orange");
                            })
                            .on("mouseout", function() {
                                tooltip.style("opacity", 0);
                                d3.select(this).attr("fill", "#1f77b4");
                            }),
                        update => update
                            .attr("x", d => (width - gap) / 2 - xAffected(d.total_affected))
                            .attr("width", d => xAffected(d.total_affected))
                            .on("mouseover", function(event, d) {
                                tooltip.style("opacity", 1)
                                    .html(`<strong>Total Affected</strong><br>${d.total_affected}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 15) + "px");
                                d3.select(this).attr("fill", "orange");
                            })
                            .on("mouseout", function() {
                                tooltip.style("opacity", 0);
                                d3.select(this).attr("fill", "#1f77b4");
                            }),
                        exit => exit.remove()
                    );

                // Update total CPI bars
                svg.selectAll(".bar.total_cpi")
                    .data(selectedData, d => d.country)
                    .join(
                        enter => enter.append("rect")
                            .attr("class", "bar total_cpi")
                            .attr("x", (width + gap) / 2)
                            .attr("y", d => y(d.country))
                            .attr("width", d => xCPI(d.total_cpi))
                            .attr("height", y.bandwidth())
                            .attr("fill", "#ff7f0e")
                            .on("mouseover", function(event, d) {
                                tooltip.style("opacity", 1)
                                    .html(`<strong>Total CPI</strong><br>${d.total_cpi.toFixed(2)}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 15) + "px");
                                d3.select(this).attr("fill", "orange");
                            })
                            .on("mouseout", function() {
                                tooltip.style("opacity", 0);
                                d3.select(this).attr("fill", "#ff7f0e");
                            }),
                        update => update
                            .attr("x", (width + gap) / 2)
                            .attr("width", d => xCPI(d.total_cpi))
                            .on("mouseover", function(event, d) {
                                tooltip.style("opacity", 1)
                                    .html(`<strong>Total CPI</strong><br>${d.total_cpi.toFixed(2)}`)
                                    .style("left", (event.pageX + 10) + "px")
                                    .style("top", (event.pageY - 15) + "px");
                                d3.select(this).attr("fill", "orange");
                            })
                            .on("mouseout", function() {
                                tooltip.style("opacity", 0);
                                d3.select(this).attr("fill", "#ff7f0e");
                            }),
                        exit => exit.remove()
                    );

                // Update country labels
                svg.selectAll(".country-label")
                    .data(selectedData, d => d.country)
                    .join("text")
                    .attr("class", "country-label")
                    .attr("x", width / 2)
                    .attr("y", d => y(d.country) + y.bandwidth() / 2)
                    .attr("dy", "0.35em")
                    .style("text-anchor", "middle")
                    .style("fill", "black")
                    .style("font-weight", "bold")
                    .style("font-size", "12px")
                    .text(d => d.country)
                    .each(function(d) {
                        const labelWidth = this.getBBox().width;
                        const availableWidth = gap - 20; // Gap between bars minus a margin
                        if (labelWidth > availableWidth) {
                            d3.select(this).style("font-size", "10px");
                        }
                    });

                // Update x-axis
                svg.select(".x-axis-total-affected")
                    .call(d3.axisBottom(xAffected).ticks(5));

                svg.select(".x-axis-total-cpi")
                    .call(d3.axisBottom(xCPI).ticks(5));
            }

            // Initialize chart with the first region
            const initialRegion = [...new Set(aggregatedData.map(d => d.region))][0];
            updateChart(initialRegion);

            // Update chart when region is changed
            regionSelect.on("change", function() {
                const selectedRegion = this.value;
                updateChart(selectedRegion);
            });

            // Add x-axis for total affected
            svg.append("g")
                .attr("class", "x-axis-total-affected")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(xAffected).ticks(5));

            // Add x-axis for total CPI
            svg.append("g")
                .attr("class", "x-axis-total-cpi")
                .attr("transform", `translate(${(width + gap) / 2},${height})`)
                .call(d3.axisBottom(xCPI).ticks(5));
        }).catch(function(error) {
            console.log("Error loading the data: " + error);
        });
    </script>
</body>
</html>
